<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelSecure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
    const supabaseUrl = "https://ukxquwebxdsjklvafonu.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVreHF1d2VieGRzamtsdmFmb251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NzU4NTUsImV4cCI6MjA3NDI1MTg1NX0.sG5I3zdym2nHh8woGWvtIiA_CKby0B0x7SlFXm3DbQk";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .page {
            display: none;
        }
        .page.active {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: radial-gradient(circle at top left, #1f2937, #111827);
        }
        .auth-form-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        /* Hide scrollbars for a cleaner look */
        .overflow-auto-hide::-webkit-scrollbar {
            display: none;
        }
        .overflow-auto-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .nav-icon.active-nav {
            color: #ffffff;
            font-weight: bold;
            transform: scale(1.1);
        }
        .nav-icon {
            color: #d1d5db; /* A lighter gray for inactive icons */
            transition: transform 0.2s, color 0.2s;
        }
    </style>
</head>
<body class="overflow-auto-hide">

<!-- ---------------- LOGIN / SIGNUP ---------------- -->
<div id="login-page" class="page active">
  <div class="auth-container">
    <div class="auth-form-card p-8 md:p-10 rounded-3xl shadow-2xl max-w-sm w-full mx-4 border border-gray-100">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900">TravelSecure</h1>
        <p class="text-gray-700 mt-2">Your journey, secured.</p>
      </div>

      <!-- LOGIN -->
      <form id="login-form" class="space-y-6">
        <h2 class="text-2xl font-semibold text-center text-gray-800">Log In</h2>
        <div>
          <input type="email" id="login-username" placeholder="Email" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
        <div>
          <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300">
          Sign In
        </button>
      </form>

      <!-- SIGNUP -->
      <form id="signup-form" class="space-y-6 hidden">
        <h2 class="text-2xl font-semibold text-center text-gray-800">Sign Up</h2>
        <div>
          <input type="text" id="signup-fullname" placeholder="Full Name" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
        <div>
          <input type="email" id="signup-contact" placeholder="Email" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
        <div>
          <input type="password" id="signup-password" placeholder="Password" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
        <!-- We’re not using the OTP UI since Supabase handles email flows -->
        <button type="submit" id="signup-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300">
          Create Account
        </button>
      </form>

      <div class="mt-8 text-center text-sm text-gray-900">
        <a href="#" id="toggle-auth" class="font-semibold text-blue-600 hover:text-blue-800 transition duration-300">
          <span id="login-link">New user? Create an account</span>
          <span id="signup-link" class="hidden">Already have an account? Log In</span>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- ---------------- HOME ---------------- -->
<div id="home-page" class="page">
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <div class="text-2xl font-bold text-blue-800">TravelSecure</div>
        <div class="relative inline-block text-left">
          <select id="language-selector" class="block w-full px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
            <option value="es">Spanish</option>
          </select>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <div class="w-[18rem] md:w-[24rem] relative">
          <input type="text" id="search-bar" placeholder="Search a destination..." class="w-full px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <div id="search-results" class="absolute w-full mt-2 bg-white rounded-xl shadow-lg z-20 hidden"></div>
        </div>
        <button class="signout-btn bg-gray-100 border border-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 hidden">
          Sign out
        </button>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-4 md:p-8">
    <section class="mb-8">
      <h2 id="popular-destinations-title" class="text-3xl font-bold text-blue-800 mb-4">Popular Destinations in India</h2>
      <p id="discover-message" class="text-gray-600 mb-6">Discover amazing states and villages waiting for you.</p>
      <div id="destination-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <section class="mb-8">
      <h2 id="news-header" class="text-3xl font-bold text-blue-800 mb-4">Travel News</h2>
      <div id="news-container" class="space-y-4">
        <p id="news-placeholder" class="text-gray-500 text-center py-8">News will be displayed here from your database.</p>
      </div>
    </section>
  </main>

  <footer class="bg-blue-800 text-white shadow-lg sticky bottom-0 z-10">
    <div class="flex justify-around items-center h-16">
      <a href="#" id="home-nav" class="nav-icon flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
        <span id="home-nav-text" class="text-xs mt-1">Home</span>
      </a>
      <a href="#" id="profile-nav" class="nav-icon flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
        <span id="profile-nav-text" class="text-xs mt-1">Profile</span>
      </a>
    </div>
  </footer>
</div>

<!-- ---------------- DESTINATION ---------------- -->
<div id="destination-page" class="page">
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center">
        <button id="back-to-home" class="mr-4 text-blue-600 hover:text-blue-800 transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <h1 id="destination-title" class="text-2xl font-bold text-blue-800">Destination</h1>
      </div>
      <button class="signout-btn bg-gray-100 border border-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 hidden">
        Sign out
      </button>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-4 md:p-8">
    <section class="mb-8">
      <h2 class="text-2xl font-semibold text-gray-700">Plan Your Trip</h2>
      <div class="mt-4">
        <label for="travel-date" class="text-gray-600">When do you want to come?</label>
        <input type="date" id="travel-date" class="w-full mt-2 px-4 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div id="crowd-bar" class="mt-4 hidden rounded-full overflow-hidden">
        <div id="crowd-message" class="text-sm font-semibold text-center py-2 px-4"></div>
      </div>
      <div id="ai-evaluation" class="mt-4 hidden p-4 bg-blue-50 rounded-xl shadow-md">
        <h3 class="font-bold text-blue-800">AI Trip Analysis:</h3>
        <p id="ai-response" class="text-gray-700 mt-2"></p>
      </div>
    </section>

    <section class="mb-8">
      <div class="tabs flex justify-around border-b border-gray-200 mb-6">
        <button class="tab-btn active-tab p-4 font-semibold text-blue-600 border-b-2 border-blue-600 transition-colors duration-300">Hotels</button>
        <button class="tab-btn p-4 font-semibold text-gray-500 hover:text-blue-600 transition-colors duration-300">Restaurants</button>
        <button class="tab-btn p-4 font-semibold text-gray-500 hover:text-blue-600 transition-colors duration-300">Verified Guides</button>
      </div>

      <div id="hotels-tab" class="tab-content active-content">
        <div id="hotels-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      </div>
      <div id="restaurants-tab" class="tab-content hidden">
        <div id="restaurants-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      </div>
      <div id="guides-tab" class="tab-content hidden">
        <div id="guides-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      </div>
    </section>
  </main>

  <footer class="bg-blue-800 text-white shadow-lg sticky bottom-0 z-10">
    <div class="flex justify-around items-center h-16">
      <a href="#" id="home-nav-dest" class="nav-icon flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
        <span class="text-xs mt-1">Home</span>
      </a>
      <a href="#" id="profile-nav-dest" class="nav-icon flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
        <span class="text-xs mt-1">Profile</span>
      </a>
    </div>
  </footer>
</div>

<!-- ---------------- PROFILE ---------------- -->
<div id="profile-page" class="page">
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center">
        <button id="back-from-profile" class="mr-4 text-blue-600 hover:text-blue-800 transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <h1 class="text-2xl font-bold text-blue-800">My Profile</h1>
      </div>
      <button class="signout-btn bg-gray-100 border border-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 hidden">
        Sign out
      </button>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-4 md:p-8">
    <section class="mb-8">
      <h2 class="text-3xl font-bold text-blue-800 mb-4">Welcome, <span id="profile-username">User</span>!</h2>
    </section>
    <section>
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">My Bookings</h2>
      <div id="bookings-container" class="space-y-4">
        <p class="text-gray-500 text-center py-8" id="no-bookings-message">No bookings found.</p>
      </div>
    </section>
  </main>

  <footer class="bg-blue-800 text-white shadow-lg sticky bottom-0 z-10">
    <div class="flex justify-around items-center h-16">
      <a href="#" id="home-nav-profile" class="nav-icon flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
        <span class="text-xs mt-1">Home</span>
      </a>
      <a href="#" id="profile-nav-profile" class="nav-icon flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
        <span class="text-xs mt-1">Profile</span>
      </a>
    </div>
  </footer>
</div>

<!-- ---------------- APP SCRIPT ---------------- -->
<script>
  // ---------- State ----------
  let currentPage = 'login-page';
  let currentDestinationSlug = null;
  let DEST_CACHE = [];

  async function getMyProfileName() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return null;
    const { data, error } = await supabaseClient
      .from('profiles')
      .select('full_name')
      .eq('id', user.id)
      .maybeSingle();
    if (error) return user.email; // fallback
    return data?.full_name || user.email;
  }

  function showSignoutButtons(show) {
    document.querySelectorAll('.signout-btn').forEach(btn => {
      if (show) btn.classList.remove('hidden'); else btn.classList.add('hidden');
    });
  }

  // ---------- Navigation ----------
  const navigateTo = async (pageId, params = {}) => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    currentPage = pageId;

    const { data: { session } } = await supabaseClient.auth.getSession();
    showSignoutButtons(!!session);

    if (pageId === 'home-page') {
      await renderDestinations();
    } else if (pageId === 'destination-page') {
      currentDestinationSlug = params.id;
      await renderDestinationDetails();
    } else if (pageId === 'profile-page') {
      document.getElementById('profile-username').innerText = (await getMyDisplayName()) || 'Guest';
      await renderBookings();
    }
  };

  // ---------- Auth UI ----------
  const loginForm = document.getElementById('login-form');
  const signupForm = document.getElementById('signup-form');
  const toggleAuthLink = document.getElementById('toggle-auth');
  const loginLink = document.getElementById('login-link');
  const signupLink = document.getElementById('signup-link');

  toggleAuthLink.addEventListener('click', (e) => {
    e.preventDefault();
    loginForm.classList.toggle('hidden');
    signupForm.classList.toggle('hidden');
    loginLink.classList.toggle('hidden');
    signupLink.classList.toggle('hidden');
    signupForm.reset();
  });

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;

    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) return alert(error.message);

    localStorage.setItem('currentUser', data.user.email || data.user.id);
    
    await ensureProfileRow();    
    navigateTo('home-page');
  });

  signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
  const fullName = document.getElementById('signup-fullname').value.trim();
  const email = document.getElementById('signup-contact').value.trim();
  const password = document.getElementById('signup-password').value;

  const { data, error } = await supabaseClient.auth.signUp({
    email,
    password,
    options: { data: { full_name: fullName } }   // IMPORTANT
  });
  if (error) return alert('Signup failed: ' + error.message);

  alert('Signup successful. If email confirmation is enabled, please confirm your email.');
  navigateTo('home-page');
  });

  // Sign out (all buttons)
  document.querySelectorAll('.signout-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      localStorage.removeItem('currentUser');
      DEST_CACHE = [];
      navigateTo('login-page');
    });
  });

  // ---------- Home: list & search ----------
  const destinationGrid = document.getElementById('destination-grid');
  const searchBar = document.getElementById('search-bar');
  const searchResultsContainer = document.getElementById('search-results');
  const navIcons = document.querySelectorAll('.nav-icon');

  async function fetchDestinations() {
    const { data, error } = await supabaseClient
      .from('destinations')
      .select('*')
      .order('name', { ascending: true });
    if (error) { console.error(error); return []; }
    return data;
  }

  async function renderDestinations() {
    if (!DEST_CACHE.length) DEST_CACHE = await fetchDestinations();
    destinationGrid.innerHTML = '';
    DEST_CACHE.forEach(dest => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer';
      card.innerHTML = `
        <img src="${dest.image_url}" alt="${dest.name}" class="w-full h-48 object-cover rounded-t-xl">
        <div class="p-4">
          <h3 class="font-bold text-xl text-blue-800">${dest.name}</h3>
          <p class="text-gray-600 mt-2">Discover the best of ${dest.name} with our trusted services.</p>
        </div>`;
      card.addEventListener('click', () => navigateTo('destination-page', { id: dest.slug }));
      destinationGrid.appendChild(card);
    });
  }

  function renderSearchResults(results) {
    searchResultsContainer.innerHTML = '';
    if (!results.length) {
      searchResultsContainer.innerHTML = `<p class="p-4 text-center text-gray-500">No destinations found.</p>`;
      return;
    }
    results.forEach(dest => {
      const a = document.createElement('a');
      a.href = '#';
      a.className = 'block p-4 hover:bg-gray-100 transition-colors duration-300 rounded-xl';
      a.innerHTML = `<h3 class="font-semibold text-gray-800">${dest.name}</h3>
                     <p class="text-sm text-gray-500">${dest.state}</p>`;
      a.addEventListener('click', (e) => {
        e.preventDefault();
        searchResultsContainer.classList.add('hidden');
        navigateTo('destination-page', { id: dest.slug });
      });
      searchResultsContainer.appendChild(a);
    });
  }

  
  searchBar.addEventListener('input', async () => {
    const q = searchBar.value.toLowerCase();
    if (!DEST_CACHE.length) DEST_CACHE = await fetchDestinations();
    if (q.length) {
      searchResultsContainer.classList.remove('hidden');
      renderSearchResults(
        DEST_CACHE.filter(d => d.name.toLowerCase().includes(q) || d.state.toLowerCase().includes(q))
      );
    } else {
      searchResultsContainer.classList.add('hidden');
      renderDestinations();
    }
  });

  navIcons.forEach(icon => {
    icon.addEventListener('click', (e) => {
      e.preventDefault();
      navIcons.forEach(n => n.classList.remove('active-nav'));
      icon.classList.add('active-nav');
    });
  });

  // ---------- Destination page ----------
  const destinationTitle = document.getElementById('destination-title');
  const hotelsGrid = document.getElementById('hotels-grid');
  const restaurantsGrid = document.getElementById('restaurants-grid');
  const guidesGrid = document.getElementById('guides-grid');
  const travelDateInput = document.getElementById('travel-date');
  const crowdBar = document.getElementById('crowd-bar');
  const crowdMessage = document.getElementById('crowd-message');
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600'));
      tabBtns.forEach(b => b.classList.add('text-gray-500', 'border-b-2', 'border-transparent'));
      btn.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
      btn.classList.remove('text-gray-500', 'border-b-2', 'border-transparent');
      tabContents.forEach(c => c.classList.add('hidden'));
      const targetId = btn.innerText.toLowerCase().replace(/\s/g, '-') + '-tab';
      document.getElementById(targetId).classList.remove('hidden');
    });
  });

  async function fetchDestinationWithItems(slug) {
    const { data: dest, error: e1 } = await supabaseClient
      .from('destinations')
      .select('id, slug, name, state, image_url, peak_months')
      .eq('slug', slug)
      .single();
    if (e1 || !dest) return null;
    const [h, r, g] = await Promise.all([
      supabaseClient.from('hotels').select('*').eq('destination_id', dest.id),
      supabaseClient.from('restaurants').select('*').eq('destination_id', dest.id),
      supabaseClient.from('guides').select('*').eq('destination_id', dest.id),
    ]);
    return { destination: dest, hotels: h.data || [], restaurants: r.data || [], guides: g.data || [] };
  }

async function ensureProfileRow() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return;
  const nameFromAuth = user.user_metadata?.full_name || '';

  const { data: row } = await supabaseClient
    .from('profiles').select('id, full_name').eq('id', user.id).maybeSingle();

  if (!row) {
    await supabaseClient.from('profiles').insert({ id: user.id, full_name: nameFromAuth });
  } else if (!row.full_name && nameFromAuth) {
    await supabaseClient.from('profiles').update({ full_name: nameFromAuth }).eq('id', user.id);
  }
}

// call after successful login and in onAuthStateChange
async function getMyDisplayName() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return 'Guest';
  const { data: row } = await supabaseClient
    .from('profiles').select('full_name').eq('id', user.id).maybeSingle();
  return (row?.full_name && row.full_name.trim()) ? row.full_name
       : (user.user_metadata?.full_name || user.email || 'Guest');
}


  async function renderDestinationDetails() {
    if (!currentDestinationSlug) return;
    const data = await fetchDestinationWithItems(currentDestinationSlug);
    if (!data) { destinationTitle.innerText = "Destination Not Found"; return; }

    const { destination: dest, hotels, restaurants, guides } = data;
    destinationTitle.innerText = dest.name;

    hotelsGrid.innerHTML = hotels.map(item => `
      <div class="bg-white rounded-xl shadow-lg p-4">
        <h3 class="font-semibold text-lg">${item.name}</h3>
        <p class="text-gray-600 text-sm mt-1">${item.price}</p>
        <div class="flex justify-between items-center mt-3">
          <span class="bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-full">${item.verified ? '✔ Verified' : ''}</span>
          <button class="book-now-btn bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-xl hover:bg-blue-700 transition">Book Now</button>
        </div>
      </div>`).join('');

    restaurantsGrid.innerHTML = restaurants.map(item => `
      <div class="bg-white rounded-xl shadow-lg p-4">
        <h3 class="font-semibold text-lg">${item.name}</h3>
        <p class="text-gray-600 text-sm mt-1">${item.price}</p>
        <div class="flex justify-between items-center mt-3">
          <span class="bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-full">${item.verified ? '✔ Verified' : ''}</span>
          <button class="book-now-btn bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-xl hover:bg-blue-700 transition">Book Now</button>
        </div>
      </div>`).join('');

    guidesGrid.innerHTML = guides.map(item => `
      <div class="bg-white rounded-xl shadow-lg p-4">
        <h3 class="font-semibold text-lg">${item.name}</h3>
        <p class="text-gray-600 text-sm mt-1">${item.price}</p>
        <div class="flex justify-between items-center mt-3">
          <span class="bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-full">${item.verified ? '✔ Verified' : ''}</span>
          <button class="book-now-btn bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-xl hover:bg-blue-700 transition">Book Now</button>
        </div>
      </div>`).join('');

    attachBookingHandlers(dest.id, dest.peak_months);
  }

  function attachBookingHandlers(destinationId, peakMonths) {
    document.querySelectorAll('.book-now-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const card = btn.closest('.bg-white');
        const itemName = card.querySelector('h3').textContent;
        const itemPrice = card.querySelector('p').textContent;
        const tabId = btn.closest('.tab-content').id.replace('-tab', ''); // hotels|restaurants|guides
        const travelDate = document.getElementById('travel-date').value;
        if (!travelDate) return alert('Please select a travel date before booking.');

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return alert('Please log in.');

        const itemType = tabId === 'hotels' ? 'Hotel' : tabId === 'restaurants' ? 'Restaurant' : 'Guide';
        const { error } = await supabaseClient.from('bookings').insert({
          user_id: user.id,
          destination_id: destinationId,
          date: travelDate,
          item_type: itemType,
          item_name: itemName,
          price: itemPrice
        });
        if (error) return alert('Booking failed: ' + error.message);

        alert('Booking successful!');
        navigateTo('profile-page');
      });
    });

    // Crowd bar from peakMonths
    document.getElementById('travel-date').onchange = (e) => {
      const selected = e.target.value;
      const month = new Date(selected).getMonth() + 1;
      crowdBar.classList.remove('bg-green-400', 'bg-red-400');
      crowdBar.classList.add('hidden');
      if (peakMonths && peakMonths.length) {
        const isPeak = peakMonths.includes(month);
        crowdBar.classList.remove('hidden');
        if (isPeak) {
          crowdBar.classList.add('bg-red-400');
          crowdMessage.textContent = "High season - expect more people!";
        } else {
          crowdBar.classList.add('bg-green-400');
          crowdMessage.textContent = "Off-season - expect fewer people!";
        }
      }
    };
  }

  // ---------- Profile: bookings ----------
  async function fetchMyBookings() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return [];
    const { data, error } = await supabaseClient
      .from('bookings')
      .select('*, destination:destinations(name, slug)')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    if (error) { console.error(error); return []; }
    return data;
  }

  async function renderBookings() {
    const bookingsContainer = document.getElementById('bookings-container');
    const rows = await fetchMyBookings();
    if (!rows.length) {
      bookingsContainer.innerHTML = `<p class="text-gray-500 text-center py-8">No bookings found for your account.</p>`;
      return;
    }
    bookingsContainer.innerHTML = rows.map(b => `
      <div class="bg-white rounded-xl shadow-lg p-4 flex justify-between items-center">
        <div>
          <h3 class="font-semibold text-lg">${b.item_name}</h3>
          <p class="text-gray-600 text-sm">Destination: ${b.destination?.name || ''}</p>
          <p class="text-gray-600 text-sm">Date: ${b.date}</p>
        </div>
        <div class="text-right">
          <span class="text-blue-600 font-bold">${b.price}</span>
          <p class="text-gray-500 text-xs mt-1">Booked: ${b.item_type}</p>
        </div>
      </div>
    `).join('');
  }

  // ---------- Language ----------
  const translations = {
    en: {
      'popular-destinations': 'Popular Destinations in India',
      'discover-message': 'Discover amazing states and villages waiting for you.',
      'search-placeholder': 'Search a destination...',
      'news-header': 'Travel News',
      'news-placeholder': 'News will be displayed here from your database.',
      'home-nav': 'Home', 'profile-nav': 'Profile',
    },
    hi: {
      'popular-destinations': 'भारत में लोकप्रिय गंतव्य',
      'discover-message': 'आपके लिए इंतजार कर रहे अद्भुत राज्यों और गांवों की खोज करें।',
      'search-placeholder': 'एक गंतव्य खोजें...',
      'news-header': 'यात्रा समाचार',
      'news-placeholder': 'आपके डेटाबेस से समाचार यहां प्रदर्शित किए जाएंगे।',
      'home-nav': 'होम', 'profile-nav': 'प्रोफ़ाइल',
    },
    es: {
      'popular-destinations': 'Destinos populares en India',
      'discover-message': 'Descubre estados y pueblos asombrosos esperándote.',
      'search-placeholder': 'Buscar un destino...',
      'news-header': 'Noticias de viaje',
      'news-placeholder': 'Las noticias se mostrarán aquí desde su base de datos.',
      'home-nav': 'Inicio', 'profile-nav': 'Perfil',
    }
  };
  const languageSelector = document.getElementById('language-selector');
  function applyTranslations(lang) {
    const t = translations[lang]; if (!t) return;
    document.getElementById('popular-destinations-title').textContent = t['popular-destinations'];
    document.getElementById('discover-message').textContent = t['discover-message'];
    document.getElementById('search-bar').placeholder = t['search-placeholder'];
    document.getElementById('news-header').textContent = t['news-header'];
    document.getElementById('news-placeholder').textContent = t['news-placeholder'];
    document.getElementById('home-nav-text').textContent = t['home-nav'];
    document.getElementById('profile-nav-text').textContent = t['profile-nav'];
  }
  if (languageSelector) languageSelector.addEventListener('change', (e) => applyTranslations(e.target.value));

  // ---------- Init ----------
  document.getElementById('back-to-home')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('home-page'); });
  document.getElementById('back-from-profile')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('home-page'); });
  document.getElementById('home-nav')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('home-page'); });
  document.getElementById('profile-nav')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('profile-page'); });
  document.getElementById('home-nav-dest')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('home-page'); });
  document.getElementById('profile-nav-dest')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('profile-page'); });
  document.getElementById('home-nav-profile')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('home-page'); });
  document.getElementById('profile-nav-profile')?.addEventListener('click', (e) => { e.preventDefault(); navigateTo('profile-page'); });

  // Start on login if no session, else go home. Also listen to auth state changes.
  (async () => {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) navigateTo('home-page'); else navigateTo('login-page');
    if (languageSelector) applyTranslations(languageSelector.value);

    supabaseClient.auth.onAuthStateChange(async (_event, sessionNow) => {
  if (sessionNow) await ensureProfileRow();
});
  })();
</script>
</body>
</html>